# PythonQuantTrading

## Plugin
### Necessary Plugin:
typing_extensions:
一個為 Python 型別提示的工具，能在型別提示中附加額外說明，適合在函式參數中提供更詳細的描述。

typing
python-dotenv
yfinance
finlab

## 1.2 透過 Alphalens 評估因子
### Alphalens
#### 如何使用 Alphalens
1. 準備數據：首先，需要準備好股價資料和因子資料，這些資料將作為後續分析的基礎
2. 整理數據：將取得的資料整理成符合 Alphalens 規定的格式，以便能夠進行有效分析
3. 計算因子數值與未來收益：使用 get_clean_factor_and_forward_returns 函式還計算因子數值及其對應的未來收益表
  這一部會產生 Alphalens 後續分析所需的清理過的因子數據和收益數據
4. 生成因子分析報表：最後，使用 create_full_tear_sheet 函式來生成最終的因子分系報表該報表提供完整的因子表現評估，幫助我們理解因子的有效性及其對投資收益的影響

概念：(P1-48)
1. quantile(分位數): 分位數是指將資料從小到大排序後，均分成若干組。常見的有五分位數或十分位數，這種方法讓投資者可以比較不同分位數的表現。
  例如：將因子資料集分為五個分位數時，第一分位數包含因子值最低的 20% 股票，最後一分位數包含因子值最高的 20% 股票。投資者可以藉由分析不同分位數的結果，討論哪個分位數下的股票表現較好。
2. bin(等間隔分組): 根據資料的數值範圍進行平均間隔的分組。每一組的範圍是相等的，不同於「quantile」根據資料數量分組。因此「bin」是將數值平均切分，而「quantile」是根據資料數量分成等量組。
3. group(分組):「group」用來根據某些屬性（如行業或市值）將資料進行分組，從而在具有相似特性的資產中進行分析。如果指定「group」，Alphalens 會在每個「group」中再進行「quantile」分組。例如：可以先按行業進行分組，然後在每個行業組內分別應用因子分析。這樣做的好處是能理解同一因子在不同行業環境下的表現是否一致。

get_clean_factor_and_forward_returns參數：
  factor：因子資料集
  prices：價格資料集
  groupby：如果有指定groupby，它用於按照股票的某些屬性（例如行業別）進行分組，就可以計算每個分組下特定的未來收益
  binning_by_group：True 時按群組獨立分箱；False 則全體一起分箱。
  quantiles：將股票依照因子數值分成的組合數量。
  bins：
  periods：設定我們希望計算未來多久後的收益
  filter_zscore：
  groupby_labels：
  max_loss：允許因子資料集中最大的遺失值比例
  zero_aware：True 時分箱會把 0 放在中性箱，適合有正負號的因子
  cumulative_returns：


Reference:
https://blog.csdn.net/gitblog_00829/article/details/146565207


1天未來收益(1D) = (明天價格-今天價格)/今天價格
5天未來收益(5D) = (5天後的價格-今天價格)/今天價格
10天未來收益(10D) = (10天後的價格-今天價格)/今天價格

#### 行業排除
排除金融業、保險業、存托憑證、建材營造業是因為這些行耶的資本結構、盈利模式與其他行業存在明顯差異，可能會對因子分析產生干擾。

#### 53個財務因子
營業利益、EBITDA、營運現金流、歸屬母公司淨利、折舊、流動資產、流動負債、取得不動產廠房及設備、經常稅後淨利、ROA稅後息前、ROA綜合損益
、ROE稅後、ROE綜合損益、稅前息前折舊前淨利率、營業毛利率、營業利益率、稅前淨利率、稅後淨利率、業外收支營收率、貝里比率、營業費用率、推銷費用率
、管理費用率、研究發展費用率、現金流量比率、稅率、每股營業額、每股營業利益、每股現金流量、每股睡前淨利、每股綜合損益、每股稅後淨利、總負債廚總淨值
、負債比率、淨值除資產、營收成長率、營業毛利成長率、資產總額成長率、淨值成長率、流動比率、速動比率、利息支出率、營運資金、總資產周轉次數、應收帳款週轉率
、存貨週轉率、固定資產周轉次數、淨值周轉率次數、自由現金流量

#### Alphalens 報表中五大分析
##### 1. 分位數統計分析 Quantiles Statistics(P1-54)
不看「平均」，而是把資料按大小排好，切成一段一段（分位數），來看整個分部長什麼樣子。此方法能讓我們觀察因子值的分布及變化，並且可以顯示是否存在異常值。如果某個分位數的值表現出乎意料的低或高，這可能表明數據中存在錯誤或者是需要進一步研究的異常情況。

##### 2. 收益分析 Returns Analysis(P1-55)
投資的收益情況，例如你購買支股票後預期所能獲得的利潤，1天的收益率(1D)表示今天買入股票並在下一個交易日賣出時的預期收益。但因實際上不能確定「未來」收益，因此只能根據過去的歷史數據來預測未來的股價走勢。亦即這裡的收益是基於過去的推測結果。

##### 3. 資訊係數分析 Information Coefficient Analysis(P1-65)
資訊係數(Information Coefficient, IC)是指「因子分數」跟「未來報酬」在「橫截面」上到底有沒有關係、關係多強。
資訊係數分析 = 系統性的檢查這個關係好不好。
例如：
當設計了一個選股因子（例如價值、動能...），從IC可以知道「當因子分數高的股票，之後真的比較會漲嗎？還是不一定？」

IC值範圍介於-1到1之間
IC值接近1：表示因子排名與未來收益之間存在強烈正相關。亦即因子值較高的股票更有可能在未來取得較好的收益。
IC值接近-1：表示因子排名與未來收益之間存在強烈負相關。亦即因子值較低的股票更有可能在未來取得較好的收益。
IC值接近0：表示因子值與未來收益之間沒有顯著的線性相關性，亦即無法區分哪些股票將在未來表現更好。

資訊係數分析對應的兩種圖表：
時間序列圖：觀察隨時間變化的IC值，愈平滑表示因子的預測能力愈穩定。
熱力圖：利用顏色深淺表示不同月份下IC值的變化，可以快速識別在一年中的哪些月份IC值表現出正/負相關

##### 4. 換手率分析 Turnover Analysis(P1-68)
衡量投資組合中資產（如股票）的變動頻率。它反映投資組合中有多少資產被替換掉的頻率。可以用來評估潛在的交易成本（例如手續費等等）
其算法為：在某個時間點t下，新加入這個分位數的資產數量（即這些資產在上一個時間段不屬於這個分位數）除以在這時間點t內屬於這個分位數的資產總數。
Turnover = 新加入資產數量/總資產數量

##### 5. 因子排名自相關分析 Factor Rank Autocorrelation Analysis(P1-69)
因子排名自相關係數是衡量某個時刻根據因子值對股票進行排名，與其過去排名之間相關性的一個指標。可以用來分析因子排名的穩定性，也就是判斷因子在不同世間斷內的表現是否一致，還是有顯著差異。
自相關性是基於股票的因子排名計算的，而非原始因子值，這樣的好處是可以更專注於在不同時間段內相對位置的變化。
因子排名自相關係數與換手率之間存在一定的反相關聯。若因子的自相關性較低，表示當前的因子排名與前期排名差異較大，也就是因子排名在短期內發生了較大的變動，這會導致投資組合的調整頻率增高，從而提高換手率，反之則反。
通常高自相關性的因子同常會被認為是較為穩定的訊號，適合用於中長期的投資策略。因為這類因子不易受到短期市場波動的影響。

##### 比較「資訊分析中的相關性」＆「因子排名自相關性」
資訊分析中的相關性：
  這種香慣性是比較「因子值與未來收益」之間的相關性。IC分析的重點在於衡量因子是否能夠「有效預測未來收益」，即因子值愈高或愈低時，是否能對應到相應的收益表現。
因子排名自相關性：
  這裡討論的是因子明在「不同時間點之間的一致性」，也就是某一時間點下的因子排名與另一時間點的因子排名之間的相關性。這種分析關注的是「因子本身隨時間的穩定性」，評估因子是否能夠在不同時間保持一致的表現。

##### 生成報告
from alphalens.tears import create_full_tear_sheet
from alphalens.utils import get_clean_factor_and_forward_returns
data = alphalens_factor_data = get_clean_factor_and_forward_returns(factor, prices, quantiles)
create_full_tear_sheet(data)

#### 總結
不要過度依賴單一分析結果。分位數統計分析、收益分析、換手率分析主要聚焦在「各個分組下」的表現。
注重換手率的，可能會更關注交易成本，因此會將投資組合的換手率上限設定在以下20%，以減少因頻繁交易而產生的額外成本。
注重IC值的，可能認為一個優秀的因子具有至少0.1的IC值，表示因子對未來收益有一定的預測能力。但若IC值超過0.2，這些投資者可能會擔心回測結果存在過度擬合的風險。因此會將IC值設定在0.10~0.20之間，來確保具有足夠預測力但又不至於過度擬合歷史數據。

## 1.3 建立財報因子選股模型挑戰選績優股(P1-73)
### 模型
在金融市場中，投資策略的建構主要依賴的兩種核心：擇時模型跟擇股模型
擇時模型：用來判斷進入或退出市場的最佳時機，適合用於操作ETF等綜合性金融產品，或是台指期這樣反映整體市場的期貨產品(P1-73)
擇股模型：用於預測市場走勢，幫助投資者決定何時進場以把握市場機會，何時退出以降低風險(P1-73)

#### 單因子選股模型
選擇一個對股票表現有預測能力的因子，並根據該因子的表現來篩選股票

#### 多因子選股模型
將多個獨立的因子結合起來，這些因子可能反映了不同的財務特徵或市場動向。

### 建立單因子選股模型(P1-73)
#### 具有良好區分能力的9種因子
營業利益
營運現金流*
歸屬母公司淨利*
經常稅後淨利
ROE稅後*
營業利益成長率*
稅後淨利成長率*
稅前淨利成長率*
應收帳款周轉率

備註：
這9個因子都顯示一短的股票組合的收益顯著低，而另一端的收益則顯著高，表明這些因子具有雙向預測的能力。
*單因子分析結果與未來生意呈正相關的因子

### 建立多因子選股模型(P1-83)
#### 綜合排序加權法
透過「加權後的綜合排序結果」來對股票進行排序。基本流程：先對每個因子進行排序，然後根據不同因子的權重對排序結果進行加權，最後得出一個綜合的排名，然後根據排名來決定交易哪些股票。
因為每個因子的數值範圍可能差異很大，例如有些因子範圍是0~1，有寫是0~1000，為避免失衡，所以需要先將不同尺度的數據統一到同一個比較基準上，使加權計算更公平。

##### 步驟
1. 了解因子與未來收益的關係
  先用 Alphalens 來分析各個單因子與未來收益之間的關係，確定每個因子是否與未來收益成正相關（亦即因子值愈大，未來收益愈高）或負相關（亦即因子值愈大，未來收益愈低）
2. 在每個時間點，根據因子與收益的相關性進行股票排序
  依據每個因子的特性，對每個時間點的股票進行排序：
    a. 如果因子值與未來收益呈「正相關」：將股票按照因子值「由小到大」排序（正相關代表因子值愈大，未來收益可能愈高，這樣未來收益高的股票會排在後面）。
    b. 如果因子值與未來收益呈「負相關」：將股票按照因子值「由大到小」排序（負相關代表因子值愈小，未來收益可能愈高，這樣未來收益高的股票會排在後面）。
3. 加權綜合排序結果
  將每個因子的排序結果進行加權計算，得到綜合排序名次。
  例如：
    等權重：每個因子的權重相等
    基於Alpha值加權：根據單因子 Alphalens 分析中獲得的Alpha值來決定各因子的權重。Alpha值愈高，說明該因子能夠產生的額外收益愈高，可以給予這個因子更高的權重。
4. 使用 Alphalens 進行因子分析
  將加權後的結果視為一個新的因子，並使用 Alphalens 來分析這個加權因子與未來收益之間的關聯性。透過這個分析可以評估該因子的預測效果。理想情況下希望看到正相關的結果，亦即排序分數愈高的股票組合應該在未來獲得更高的收益
5. 建構選股模型
  若步驟四的因子分析符合預期，亦即因子值愈大，收益愈正，因子值愈小，收益愈負，就可以仿照建構單因子選股模型策略步驟。

###### 總結
綜合排序加權法騎士只是將多個銀子的資訊整合成單一因子，然後依據 Alphalens 的分析結果來設計適合的選股模型。


















### 主成份分析法
在資料分析中，主成份分析的目的是從大量的變數中，透過組合的方式來生成少數新的變數，這些新變數稱為「主成份」。
主成份是基於原始變數生成的，能夠捕捉資料中的大部分重要資訊，同時，主成份的數量會比原始變數少，從而有效降低數據的複雜性。
透過此分析，可以去除一些資訊量較少的變數，或者去除那些傳達相似資訊的變數，讓我們能夠更聚焦在最重要的部分。
例如：
「營業利益」、「營業利益率」、「營業營收比」這三個只表可能都在傳達相似的資訊，透果主成份分析，可能就會將它們合併為一個與營業相關的主成份，這樣就大大減少了變數的數量，同時保留了數據中最關鍵的訊息。


### 模型選擇
靜態選股模型：
使用「固定的單因子」或「固定的多因子組合」來建立選股策略。這類模型的優點在於操作簡單，特別適合那些對市場變動不敏感、且能在長期內保持穩定效果的因子。假如每一季都使用「營業發展累用率」因子來選擇股票．前4名的股票進行買入，後4名的股票進行賣出(先賣後買的策略)，當下一季跌出前4名或後4名的時候就對股票進行平倉(賣出/買入)。
動態選股模型：
動態選股模型會隨著時間的推移進行滾動更新．根據每個時期的最佳因子來調整選股策略。其核心在於「因子的輪動性」，因為不同的因子表現會隨著市場條件變化而有所不同。在某些市場條件下，特定因子可能表現優異，但在其他時期則可能有不同的因子更具優勢。例如在2014年的第一季「營業發顫費用率」，但到了下一季如果「稅後淨利成長率」的表現更加，那麼便在下一季改用這個因子進行選股，一樣每一季的前4名進行買入，後4名進行賣出，在下一季跌出前4名或後4名的時候就對股票進行平倉(賣出/買入)。

至於要用哪種模型，因該去觀測財報因子表現的穩定性，如果一個因子長期表現穩定，那可以選擇相對簡單的靜態選股模型，相反的，動態選股模型會更適合(P105)


### 常見回測框架
Backtrader(pip install backtrader)
Backtest
Vnpy
Zipline


### 視覺化呈現框架
Pyfolio(pip install pyfolio-reloaded)


### Backtrader
Backtrader 在 bt.Strategy 中常見的內建方法：
__init__(): 初始化方法，在策略開始時執行，用於設置指標，包含定義策略會使用到的參數
next()：每個時間步驟執行的方法，用於定義交易策略邏輯的函式
notify_order()：追蹤訂單的狀態，「訂單狀態」變化時自動觸發。訂單狀態包含了提交、接受、完成、取消、拒絕等狀態
notify_trade()：追蹤交易的狀態，「交易狀態」變化時自動觸發。任何已經平倉的交易的可以在滯個方法裡面顯示利潤
stop()：策略結束時執行的方法
buy()：建立一個買出訂單，但還沒執行，會在下一個交易時間點執行買入動作。關於訂單的執行狀態可以透過 notify_order 來得知
sell()：建立一個賣出訂單，但還沒執行，會在下一個交易時間點執行買入動作。關於訂單的執行狀態可以透過 notify_order 來得知
log()：定義回測執行過程中要輸出的內容，可以幫助我們了解策略執行的狀態

#######
Backtrader 的對應關係:
0: Created
1: Submitted
2: Accepted
3: Partial
4: Completed
5: Canceled
6: Expired
7: Margin
8: Rejected

### Backtrader 內建常用的指標函式使用範例
簡單移動平均(SMA):
bt.indicators.SimpleMovingAverage(self.data.close.period=20)

指數移動平均(EMA):
bt.indicators.ExponentialMovingAverage(self.data.close, period=20)

相對強弱指數(RSI):
bt.indicators.RSI(self.data.close, period=14)

指數平滑異同移動平均(MACD):
bt.indicators.MACD(self.data.close, period_me1=12, period_me=2, period_singl=9)

布林帶(Bollinger Bands):
bt.indicators.BollingerBands(self.data.close, period=20, devfactor=2.0)

動量指標(Momentum):
bt.indicators.Momentum(self.data.close, period=12)

### 
收益 Return：
收益涵蓋了幾個關鍵指標，例如：每日收益(returns)、每月收益(Monthly returns)、年化收益(Annual returns)和累積收益(Cumulative returns)。這些指標幫助我們從不同的時間維度去了解策略的表現。(P1-134)

波動性 Volatility：
描述資產價格在一定時間內的變化幅度，是用來評估風險的重要指標。策略的波動性高代表資產的變動幅度大。(P1-136)

夏普比率 Sharpe ratio：
用來衡量每單位風險所帶來的超額報酬，數值愈高表示該投資在考慮風險後的收益表現越好。(P1-137)

最大回撤 Max Drawdown：
回撤是衡量投資從最高點到最低點的損失幅度，是評估風險的重要指標之一。可讓投資者了解在最不利的市場條件下，可能會面臨多大的損失(P1-138)

相對強弱指標 Relative Strength Index:
是一個 0～100 的指標，用「最近一段時間漲 vs 跌的力道」來衡量多空動能，常用來判斷超買／超賣與行情強弱。
股價每天都在漲跌，但有時候：
*是一路慢慢往上、回檔很少 → 多頭強
*是一路慢慢往下、反彈很弱 → 空頭強

RSI 就是在量化這件事：
看最近 N 根 K 棒（最常用是 14 根）的：
*平均「漲幅」有多大
*平均「跌幅」有多大

然後比較：到底是漲比較用力，還是跌比較用力

### OHLCV
OHLCV 是金融市場中用於描述證券（如股票、加密貨幣等）在特定時間段內的交易活動的關鍵數據。它代表「開盤價 (Open)」、「最高價 (High)」、「最低價 (Low)」、「收盤價 (Close)」和「成交量 (Volume)」。這五個數據點共同繪製成圖表，例如蠟燭圖或美國線，用於分析價格走勢。 