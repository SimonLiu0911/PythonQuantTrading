# PythonQuantTrading

## Plugin
### Necessary Plugin:
typing_extensions:
一個為 Python 型別提示的工具，能在型別提示中附加額外說明，適合在函式參數中提供更詳細的描述。

typing
python-dotenv
yfinance
finlab

## 1.2 透過 Alphalens 評估因子
### Alphalens
#### 如何使用 Alphalens
1. 準備數據：首先，需要準備好股價資料和因子資料，這些資料將作為後續分析的基礎
2. 整理數據：將取得的資料整理成符合 Alphalens 規定的格式，以便能夠進行有效分析
3. 計算因子數值與未來收益：使用 get_clean_factor_and_forward_returns 函式還計算因子數值及其對應的未來收益表
  這一部會產生 Alphalens 後續分析所需的清理過的因子數據和收益數據
4. 生成因子分析報表：最後，使用 create_full_tear_sheet 函式來生成最終的因子分系報表該報表提供完整的因子表現評估，幫助我們理解因子的有效性及其對投資收益的影響

概念：(P1-48)
1. quantile(分位數): 分位數是指將資料從小到大排序後，均分成若干組。常見的有五分位數或十分位數，這種方法讓投資者可以比較不同分位數的表現。
  例如：將因子資料集分為五個分位數時，第一分位數包含因子值最低的 20% 股票，最後一分位數包含因子值最高的 20% 股票。投資者可以藉由分析不同分位數的結果，討論哪個分位數下的股票表現較好。
2. bin(等間隔分組): 根據資料的數值範圍進行平均間隔的分組。每一組的範圍是相等的，不同於「quantile」根據資料數量分組。因此「bin」是將數值平均切分，而「quantile」是根據資料數量分成等量組。
3. group(分組):「group」用來根據某些屬性（如行業或市值）將資料進行分組，從而在具有相似特性的資產中進行分析。如果指定「group」，Alphalens 會在每個「group」中再進行「quantile」分組。例如：可以先按行業進行分組，然後在每個行業組內分別應用因子分析。這樣做的好處是能理解同一因子在不同行業環境下的表現是否一致。

get_clean_factor_and_forward_returns參數：
  factor：因子資料集
  prices：價格資料集
  groupby：如果有指定groupby，它用於按照股票的某些屬性（例如行業別）進行分組，就可以計算每個分組下特定的未來收益
  binning_by_group：True 時按群組獨立分箱；False 則全體一起分箱。
  quantiles：將股票依照因子數值分成的組合數量。
  bins：
  periods：設定我們希望計算未來多久後的收益
  filter_zscore：
  groupby_labels：
  max_loss：允許因子資料集中最大的遺失值比例
  zero_aware：True 時分箱會把 0 放在中性箱，適合有正負號的因子
  cumulative_returns：


Reference:
https://blog.csdn.net/gitblog_00829/article/details/146565207


1天未來收益(1D) = (明天價格-今天價格)/今天價格
5天未來收益(5D) = (5天後的價格-今天價格)/今天價格
10天未來收益(10D) = (10天後的價格-今天價格)/今天價格

#### 行業排除
排除金融業、保險業、存托憑證、建材營造業是因為這些行耶的資本結構、盈利模式與其他行業存在明顯差異，可能會對因子分析產生干擾。

#### 53個財務因子
營業利益、EBITDA、營運現金流、歸屬母公司淨利、折舊、流動資產、流動負債、取得不動產廠房及設備、經常稅後淨利、ROA稅後息前、ROA綜合損益
、ROE稅後、ROE綜合損益、稅前息前折舊前淨利率、營業毛利率、營業利益率、稅前淨利率、稅後淨利率、業外收支營收率、貝里比率、營業費用率、推銷費用率
、管理費用率、研究發展費用率、現金流量比率、稅率、每股營業額、每股營業利益、每股現金流量、每股睡前淨利、每股綜合損益、每股稅後淨利、總負債廚總淨值
、負債比率、淨值除資產、營收成長率、營業毛利成長率、資產總額成長率、淨值成長率、流動比率、速動比率、利息支出率、營運資金、總資產周轉次數、應收帳款週轉率
、存貨週轉率、固定資產周轉次數、淨值周轉率次數、自由現金流量

#### Alphalens 報表中五大分析
##### 1. 分位數統計分析 Quantiles Statistics(P1-54)
不看「平均」，而是把資料按大小排好，切成一段一段（分位數），來看整個分部長什麼樣子。此方法能讓我們觀察因子值的分布及變化，並且可以顯示是否存在異常值。如果某個分位數的值表現出乎意料的低或高，這可能表明數據中存在錯誤或者是需要進一步研究的異常情況。

##### 2. 收益分析 Returns Analysis(P1-55)
投資的收益情況，例如你購買支股票後預期所能獲得的利潤，1天的收益率(1D)表示今天買入股票並在下一個交易日賣出時的預期收益。但因實際上不能確定「未來」收益，因此只能根據過去的歷史數據來預測未來的股價走勢。亦即這裡的收益是基於過去的推測結果。

##### 3. 資訊係數分析 Information Coefficient Analysis(P1-65)
資訊係數(Information Coefficient, IC)是指「因子分數」跟「未來報酬」在「橫截面」上到底有沒有關係、關係多強。
資訊係數分析 = 系統性的檢查這個關係好不好。
例如：
當設計了一個選股因子（例如價值、動能...），從IC可以知道「當因子分數高的股票，之後真的比較會漲嗎？還是不一定？」

IC值範圍介於-1到1之間
IC值接近1：表示因子排名與未來收益之間存在強烈正相關。亦即因子值較高的股票更有可能在未來取得較好的收益。
IC值接近-1：表示因子排名與未來收益之間存在強烈負相關。亦即因子值較低的股票更有可能在未來取得較好的收益。
IC值接近0：表示因子值與未來收益之間沒有顯著的線性相關性，亦即無法區分哪些股票將在未來表現更好。

資訊係數分析對應的兩種圖表：
時間序列圖：觀察隨時間變化的IC值，愈平滑表示因子的預測能力愈穩定。
熱力圖：利用顏色深淺表示不同月份下IC值的變化，可以快速識別在一年中的哪些月份IC值表現出正/負相關

##### 4. 換手率分析 Turnover Analysis(P1-68)
衡量投資組合中資產（如股票）的變動頻率。它反映投資組合中有多少資產被替換掉的頻率。可以用來評估潛在的交易成本（例如手續費等等）
其算法為：在某個時間點t下，新加入這個分位數的資產數量（即這些資產在上一個時間段不屬於這個分位數）除以在這時間點t內屬於這個分位數的資產總數。
Turnover = 新加入資產數量/總資產數量

##### 5. 因子排名自相關分析 Factor Rank Autocorrelation Analysis(P1-69)
因子排名自相關係數是衡量某個時刻根據因子值對股票進行排名，與其過去排名之間相關性的一個指標。可以用來分析因子排名的穩定性，也就是判斷因子在不同世間斷內的表現是否一致，還是有顯著差異。
自相關性是基於股票的因子排名計算的，而非原始因子值，這樣的好處是可以更專注於在不同時間段內相對位置的變化。
因子排名自相關係數與換手率之間存在一定的反相關聯。若因子的自相關性較低，表示當前的因子排名與前期排名差異較大，也就是因子排名在短期內發生了較大的變動，這會導致投資組合的調整頻率增高，從而提高換手率，反之則反。
通常高自相關性的因子同常會被認為是較為穩定的訊號，適合用於中長期的投資策略。因為這類因子不易受到短期市場波動的影響。

##### 比較「資訊分析中的相關性」＆「因子排名自相關性」
資訊分析中的相關性：
  這種香慣性是比較「因子值與未來收益」之間的相關性。IC分析的重點在於衡量因子是否能夠「有效預測未來收益」，即因子值愈高或愈低時，是否能對應到相應的收益表現。
因子排名自相關性：
  這裡討論的是因子明在「不同時間點之間的一致性」，也就是某一時間點下的因子排名與另一時間點的因子排名之間的相關性。這種分析關注的是「因子本身隨時間的穩定性」，評估因子是否能夠在不同時間保持一致的表現。

##### 生成報告
from alphalens.tears import create_full_tear_sheet
from alphalens.utils import get_clean_factor_and_forward_returns
data = alphalens_factor_data = get_clean_factor_and_forward_returns(factor, prices, quantiles)
create_full_tear_sheet(data)

#### 總結
不要過度依賴單一分析結果。分位數統計分析、收益分析、換手率分析主要聚焦在「各個分組下」的表現。
注重換手率的，可能會更關注交易成本，因此會將投資組合的換手率上限設定在以下20%，以減少因頻繁交易而產生的額外成本。
注重IC值的，可能認為一個優秀的因子具有至少0.1的IC值，表示因子對未來收益有一定的預測能力。但若IC值超過0.2，這些投資者可能會擔心回測結果存在過度擬合的風險。因此會將IC值設定在0.10~0.20之間，來確保具有足夠預測力但又不至於過度擬合歷史數據。

## 1.3 建立財報因子選股模型挑戰選績優股(P1-73)
### 模型
在金融市場中，投資策略的建構主要依賴的兩種核心：擇時模型跟擇股模型
擇時模型：用來判斷進入或退出市場的最佳時機，適合用於操作ETF等綜合性金融產品，或是台指期這樣反映整體市場的期貨產品(P1-73)
擇股模型：用於預測市場走勢，幫助投資者決定何時進場以把握市場機會，何時退出以降低風險(P1-73)

#### 單因子選股模型
選擇一個對股票表現有預測能力的因子，並根據該因子的表現來篩選股票

#### 多因子選股模型
將多個獨立的因子結合起來，這些因子可能反映了不同的財務特徵或市場動向。

### 建立單因子選股模型(P1-73)
#### 具有良好區分能力的9種因子
營業利益
營運現金流*
歸屬母公司淨利*
經常稅後淨利
ROE稅後*
營業利益成長率*
稅後淨利成長率*
稅前淨利成長率*
應收帳款周轉率

備註：
這9個因子都顯示一短的股票組合的收益顯著低，而另一端的收益則顯著高，表明這些因子具有雙向預測的能力。
*單因子分析結果與未來生意呈正相關的因子

### 建立多因子選股模型(P1-83)
#### 綜合排序加權法
透過「加權後的綜合排序結果」來對股票進行排序。基本流程：先對每個因子進行排序，然後根據不同因子的權重對排序結果進行加權，最後得出一個綜合的排名，然後根據排名來決定交易哪些股票。
因為每個因子的數值範圍可能差異很大，例如有些因子範圍是0~1，有寫是0~1000，為避免失衡，所以需要先將不同尺度的數據統一到同一個比較基準上，使加權計算更公平。

##### 步驟
1. 了解因子與未來收益的關係
  先用 Alphalens 來分析各個單因子與未來收益之間的關係，確定每個因子是否與未來收益成正相關（亦即因子值愈大，未來收益愈高）或負相關（亦即因子值愈大，未來收益愈低）
2. 在每個時間點，根據因子與收益的相關性進行股票排序
  依據每個因子的特性，對每個時間點的股票進行排序：
    a. 如果因子值與未來收益呈「正相關」：將股票按照因子值「由小到大」排序（正相關代表因子值愈大，未來收益可能愈高，這樣未來收益高的股票會排在後面）。
    b. 如果因子值與未來收益呈「負相關」：將股票按照因子值「由大到小」排序（負相關代表因子值愈小，未來收益可能愈高，這樣未來收益高的股票會排在後面）。
3. 加權綜合排序結果
  將每個因子的排序結果進行加權計算，得到綜合排序名次。
  例如：
    等權重：每個因子的權重相等
    基於Alpha值加權：根據單因子 Alphalens 分析中獲得的Alpha值來決定各因子的權重。Alpha值愈高，說明該因子能夠產生的額外收益愈高，可以給予這個因子更高的權重。
4. 使用 Alphalens 進行因子分析
  將加權後的結果視為一個新的因子，並使用 Alphalens 來分析這個加權因子與未來收益之間的關聯性。透過這個分析可以評估該因子的預測效果。理想情況下希望看到正相關的結果，亦即排序分數愈高的股票組合應該在未來獲得更高的收益
5. 建構選股模型
  若步驟四的因子分析符合預期，亦即因子值愈大，收益愈正，因子值愈小，收益愈負，就可以仿照建構單因子選股模型策略步驟。

###### 總結
綜合排序加權法騎士只是將多個銀子的資訊整合成單一因子，然後依據 Alphalens 的分析結果來設計適合的選股模型。


### 靜態/動態選股模型(P1-103)
因為因子與收益的關係經常變動，投資者需要根據這些變化來調整投資策略。因此在建立模型時，不僅僅是使用單因子或多因子，還要決定選用「靜態模型」還是「動態模型」。

#### 靜態選股模型
使用「固定的單因子」或「固定的多因子」來建立選股策略。適合對市場變動不敏感且能長期內保持穩定效果的因子。

#### 動態選股模型
會隨著時間的推移進行滾動更新，根據每個時期的最佳因子來調整選股策略。這類模型的核心在於「因子的輪動性」，因為不同因子表現會隨著市場條件變化而有所不同。

##### 總結
財報因子的表現穩定性是選擇靜態還是動態選股模型的關鍵。如過一個因子的表現長期穩定，就可以選擇操作簡單的靜態選股模型，反之則反。

## 1.4 財報因子選股模型回測績效
### 常見回測框架
Backtrader(pip install backtrader)
Backtest
Vnpy
Zipline

### 視覺化呈現框架
Pyfolio(pip install pyfolio-reloaded)

### Backtrader介紹
一個量化交易研究平台，提供策略開發、回測、策略優化和實際交易執行的功能。需要建立一個 Cerebro 回測引擎實例，然後給它數據來源、交易策略、觀察的指標，它會根據這些資訊進行計算並給出回測結果。

建立一個 Cerebro 實例，它是Backtrader 的核心引擎，管理資料、策略和回測流程。
cerebro = bt.Cerebro()

將回測資料加入 Cerebro 實例。資料可以來自 CSV 檔案、資料庫或其他資料來源。
cerebro.adddate(data)

將交易策略加入 Cerebro 實例。策略定義了交易邏輯和規則。
cerebro.addstrategy(strategy)

添加各種分析器來評估策略的表現，像是夏普比率。分析器會在策略運行計算相管的績效指標。
cerebro.addanalyzer(bt.analyzers.SharpeRatio, _name="sharp")

設置初始資金、手續費。
cerebro.broker.setcommission(commission=0.0015)
cerebro.broker.setcash(initial_cash)

開始回測
cerebro.run()

#### 加載回測數據
一般分成三種：「讀取CSV檔案」、「從yfinance下載資料」、「自訂資料格式」。只要數據能夠透過 adddate 函式順利加載並沒有出現錯誤，就可以開始回測了。

##### 讀取CSV檔案
Backtrader 有提供 GenericCSVData 方法來加載 CSV 檔案。只需要在 dataname 參數中指定 CSV 檔案的路徑。
在使用 GenericCSVData 加載 CSV 檔案時，必須指定資料中各個欄位的位置，包含datetime（日期）、open（開盤價）、high（最高價）、low（最低價）、close（收盤價）、volume（成交量）、openinterest（未平倉合約數）。
若時間欄位在 CSV 檔案的第一欄，就將 datetime 設為 0；若開盤價在第二欄，就將 open 設為 1。如果有不存在的欄位，例如 openinterest，可以將它設為 -1，表示資料中沒有這個欄位。

##### 從 yfinance 下載資料
要使用這個方法需要透過 yfinance 指定股票代碼以及所需數據的日期範圍，接著即可將下載的數據加載進 Backtrader 進行回測。
由於 yfinance 直接拿到的是 pandas.DataFeame（有 DatetimeIndex、欄位 Open/High/Low/Close/Volume），不是 CSV 檔或自訂 feed。因此用 Backtrader 內建的 PandasData 把現有的 DataFrame 映射成它需要的資料格式。

##### 自訂資料格式
當回測資料包含自定義欄位時，可以使用自訂資料格式加載數據。首先需要繼承 bt.feeds.PandasData 類，並在 params 中宣告自訂欄位名稱。
param 是預設的datetime（日期）、open（開盤價）、high（最高價）、low（最低價）、close（收盤價）、volume（成交量）、openinterest（未平倉合約數）這幾個，再把你要自定義的寫在這裡。
假設增加的兩個自定義欄位是 factor1, factor2，其設定可以是 ("factor1", 6) 和 ("factor2", 7)，6和7表示第七欄跟第八欄。也可以使用欄位名稱 ("factor1", "factor1") 或 ("factor2", "factor2")

##### 設定交易策略
在定義策略時，首先需要了解如何取得當日或過去幾天的資料，才能將這些資料運用到交易邏輯中。在 Backtrader 的策略中，會使用 self.data 來存取透過 adddata 韓式加入的資料。如果加入了多個股票資料，self.data 就是一個資料序列，序列中的每個元素代表一支股票的歷史資料。可以透過索引來取得序列中的資料，例如 self.datas[0]取得第一支股票的歷史資料。
每個屬性資料又可以看作一個序列，一樣也是透過索引來獲取，當前資料索引值就是0，上個時間點的資料索引值就是-1，例如當下時間點的收盤價就是self.datas[0].close[0]，前一個時間點的收盤價則是 self.datas[0].close[-1]

寫策略模組首先要繼承 bt.Strategy 模組，繼承後就可以去定義會使到的韓式，其中最重要的就是 next 這個韓式，要把策略的邏輯都寫在裡面，包含提供交易時的訊息或是執行買入、賣出動作。


###### 策略內常見函式介紹
init(): 初始化交易策略，包含定義策略會使用到的參數。
next(): 定義策略邏輯的函式。
log(): 定義回測執行過程中要輸出的內容，可以幫助我們了解策略執行的狀態。
notify_order(): 追蹤訂單的狀態，「訂單狀態」變化時自動觸發。訂單狀態包含了提交、接受、完成、取消、拒絕等狀態。
notify_trade(): 追蹤交易的狀態，「交易狀態」變化時自動觸發。任何已經平倉的交易都可以在這個方法裡面顯示利潤。
buy(): 建立一個買入訂單，但還沒執行，會在下一個交易時間點執行買入動作。關於訂單的執行狀態可以透過 notify_order 來得知。
sell(): 建立一個賣出訂單，但還沒執行，會在下一個交易時間點執行賣出動作。關於訂單的執行狀態可以透過 notify_order 來得知。

策略程式架構：
class YourStrategy(bt.Strategy):
  def __init__(self):
    pass
  def log(self, txt, dt=None):
    pass
  def next(self, order):
    pass
  def notify_order(self, order):
    pass
  def notify_trade(self, order):
    pass

在 next 函式中可以呼叫 self.buy() 或是 self.sell() 函式

###### order.status 訂單狀態
order.Submitted: 訂單已經被創建並提交到交易系統，但還沒有被處理。
order.Accepted: 訂單已經進入了市場的處理中，但還沒有被執行。
order.Completed: 訂單已經成功執行買入或賣出，交易已經完成。進一步可以透過 order.isbuy() 或是 order.issell() 來確認是買入還是賣出的訂單。
order.Rejected: 訂單被拒絕。發生的原因可能是資金不足。
order.Canceled: 訂單被取消。
order.Margin: 當交易嘗試執行時，帳戶中可用資金或保證金不足已完成該交易。

###### 訂單資訊
order.executed.price: 訂單被執行的單價。
order.executed.value: 訂單被執行的總價值，也就是單價乘上交易數量。
order.executed.comm: 執行訂單產生的手續費。
trade.pnl: 不考慮手續費下的淨盈虧。
trade.pnlcomm: 考慮手續費下的淨盈虧。

###### 分析器使用範例
1. 夏普比率 Sharpe Ratio
cerebro.addanalyzer(bt.analyzers.SharpeRatio)
results = cerebro.run()
strat = results[0]
strat.analyzers.sharperatio.get_analysis()
strat.analyzers.sharperatio.get_analysis()['sharperatio']

2. 回撤 Drawdown
cerebro.addanalyzer(bt.analyzers.DrawDown)
results = cerebro.run()
strat = results[0]
strat.analyzers.drawdown.get_analysis()
strat.analyzers.drawdown.get_analysis()['drawdown']

3. 收益 Returns
cerebro.addanalyzer(bt.analyzers.Returns)
results = cerebro.run()
strat = results[0]
strat.analyzers.returns.get_analysis()

4. Pyfolio
cerebro.addanalyzer(bt.analyzers.Pyfolio)
results = cerebro.run()
strat = results[0]
strat.analyzers.pyfolio.get_analysis()

###### cerebro.broker 的使用範例
1. 取得當前帳戶的現金餘額
cerebro.broker.getcash()

2. 取得當前帳戶的總額（包含現金和持倉的市值）
cerebro.broker.getvalue()

3. 取得持倉的價格
cerebro.broker.getposition(data).price

4. 取得持倉的數量
cerebro.broker.getposition(data).size

###### Backtrader 內建常用的指標函式使用範例
簡單移動平均(SMA):
bt.indicators.SimpleMovingAverage(self.data.close.period=20)

指數移動平均(EMA):
bt.indicators.ExponentialMovingAverage(self.data.close, period=20)

相對強弱指數(RSI):
bt.indicators.RSI(self.data.close, period=14)

指數平滑異同移動平均(MACD):
bt.indicators.MACD(self.data.close, period_me1=12, period_me=2, period_singl=9)

布林帶(Bollinger Bands):
bt.indicators.BollingerBands(self.data.close, period=20, devfactor=2.0)

動量指標(Momentum):
bt.indicators.Momentum(self.data.close, period=12)


### Pyfolio 介紹
Pyfolio 是一個廣泛使用的投資風險與回報分析工具(分析器)，常用於 Jupyter Notebook 中進行視覺化顯示。
在 Pyfolio 中，可以透過 benchmark_rets 參數來指定基準資料。如需要區分歷史資料和實盤資料，可以使用 live_start_date 參數來設置實盤資料開始的日期。在這個日期之前的數據被視為歷史回測資料，之後的數據則視為交易資料。

<!-- 分析報表解讀 -->
收益 Return：
收益涵蓋了幾個關鍵指標，例如：每日收益(returns)、每月收益(Monthly returns)、年化收益(Annual returns)和累積收益(Cumulative returns)。這些指標幫助我們從不同的時間維度去了解策略的表現。(P1-134)

波動性 Volatility：
描述資產價格在一定時間內的變化幅度，是用來評估風險的重要指標。策略的波動性高代表資產的變動幅度大。(P1-136)

夏普比率 Sharpe ratio：
用來衡量每單位風險所帶來的超額報酬，數值愈高表示該投資在考慮風險後的收益表現越好。(P1-137)

最大回撤 Max Drawdown：
回撤是衡量投資從最高點到最低點的損失幅度，是評估風險的重要指標之一。可讓投資者了解在最不利的市場條件下，可能會面臨多大的損失(P1-138)


## 2.1 認識價量因子

交易量數據指的是在一段時間內的資產成交總量，可以反映市場活躍度和投資者對價格變動的信心水平。

## 創建價量因子的常見手法
<!-- 移動平均(P2-4) -->
其用途在於讓數據變得更平滑，能過濾掉短期的市場波動，突顯出長期的趨勢。常見的計算移動平均方法是計算兩種不同時間長度的移動平均，將計算天數較多的移動平均視為「長期趨勢」，較少天數的則視為「短期趨勢」。

<!-- 加權平均(P2-4) -->
加權平均是一種移動平過的變形，在計算平均時，考慮每個資料點有不同的權重。

<!-- 相關係數(P2-5) -->
用於衡量兩個變數之間的相關性強度和方向，變涼可以是相同類型的資料，也可以是不同類型的資料。在價格和交易量的分析中，經常被用來識別價格與交易量之間的關聯性、衡量不同商品之間的價格相關性，或評估不同商品的交易量相關性。除了計算相關係數，也可以透過像是熱點圖、散布圖來觀察多個變量之間的相關性。

<!-- 排序(P2-7) -->
將資料集中的數據點按照某個特定值進行排序，這種情境通常適用於只關心數值的大小關係，而不在意它們的絕對數值。

<!-- 統計量(P2-7) -->
用來描述資料的集中趨勢和分散程度的指標，幫助我們理解資料的整體分布情況，例如資料是否偏向某一方向、分散程度如何等等。


<!-- 標準化(P2-8) -->
一種將數據調整到共同範圍內的方式，有助於消除不同數據集之間的障礙。常見的有：Z-Cored標準化、最小最大標準化、小樹縮放。

## 四大類價量因子
### 動量因子(P2-10)
基於「強者恆強，弱者恆弱」的趨勢，認為股票在未來一段時間內有很高的可能性會持續過去的趨勢。

#### 常見相關因子：
##### 相對強弱指數(Relative Strength Index, RSI)
這個指數用來評估股價在近期內的上升和下降幅度。當 RSI 在 70 到 100 之間時，代表該資產處魚強勁的上升階段，這通常視為超買區，但過高的 RSI 也意味著短期內價家過熱，有回調風險。反之，當 RSI 在 0 到 30 之間時，表示進入強勢下跌的階段，通常視為超賣區。若 RSI 介於 50 到 70 之間，代表漲幅比例偏高；介於 30 到 50 則顯示跌幅比例較大。

##### 移動平均收斂發散指標(Moving Average Convergence Divergence, MACD)
透過比較短期和長期的平均價格變化，來判斷趨勢方向和動量變化。MACD 關鍵在於「離差值」的計算。離差值是指短期與長期的指數平滑移動平均線(Exponential Moving Average, EMA)之間的差異。通常會把短期設為 12 天，長期設為 26 天，這樣就能捕捉各五架短期和長期的波動對比，但光看離差值還無法評估市場動能的強弱，因此需要一個基準來確認，此基準也叫「訊號線」(Signal Line)，通常設定 9 天的 EMA。
訊號線就像是對離差值的平滑化，可以幫助過濾掉短期的價格波動，讓我們可以看到趨勢。訊號線反應較慢，因此稱為「慢線」，原始離差值反應較快，被稱為「快線」。最終，MACD 指標就變成快線與慢線的差異。

##### 隨機震盪指數(Stochastic Oscillator, KD)(P2-13)
這個指標用來衡量股價在壹定時間內的收盤價，與其在該時段內最高價和最低價的相對位置。可以幫助投資人判斷市場是否進入了價格高估(超買)或低估(超賣)的區域。
KD指標有兩條主要線：快線(K)和慢線(D)，K線對價格變動更敏感，D線因平滑處理反應較慢，因五可以視為趨勢的「穩定指標」。若K線和D線的值較高(如超過 80)，表示價格可能已接近短期的高點，是超買的訊號，若KD值偏低(如低於 20)，則可能是超賣的訊號。另外代表性的信號是「交叉點」。當K線從下方穿越D線，表示價格短期有回升的潛力，反之則反。


### 反轉因子
假設「市場價格在短期內過度反應，長期會回歸平均值」，反轉因子就會根據過去的價格或交易量資料來捕捉這些反轉信號，尋找價格偏離均值的機會。

#### 常見相關因子：
##### 布林通道(Bollnger Bands)
布林通道是一條中間線(通常是20日移動平均線)和兩條上下壓力線構成。這兩條壓力線設在中間線的上下方，分別加減兩倍標準差，稱為上軌和下軌，用來衡量市場超買貨超賣的狀態。

##### 頂部反轉模式 - 頭肩頂
頭肩頂是一種常見的頂部反轉型態，通常出現在上升趨勢的尾端，暗示價格可能會從上升轉向下降。這個模式由三個峰組成：中間的峰(頭)最高，兩側的峰(肩)較低。當價格向下突破頸線時為一個出信好，表明可能會開始下跌趨勢。

##### 底部反轉模式 - 頭肩底
頭肩底是頭肩頂的鏡像，屬於底部反轉模式，通常出現在下降趨勢的尾端，表示價格可能即將從下降轉為上升。

### 波動率因子
波動率因子專注於價格和交易量的變動幅度，通常高波動率伴隨著更高的風險和不確定性，因此在風險管理中扮演了重要角色。適合用於風險管理和投資組合優化。當投資者希望降低投資組合的波動風險時，可以藉助波動率因子來調整資產配置，進而達到穩定收益的效果。

#### 常見相關因子：
##### 平均真實波動幅度(Average True Range，ATR)
用來追蹤特定時間內的價格波動情況。ATR 不僅顯示市場價格波動的程度，也能反映出交易者對市場的熱情程度。當ATR增加，代表市場活躍，交易者在當天頻繁買人或賣出；反之則反。

##### 布林通道(Bollnger Bands)
布林通道不僅能顯示價格的超買或超賣狀態，它的「通道寬度」也是衡量市場波動性的工具。當市場波動性增加時，布林通道的上軌和下軌會隨著標準差的增加而變寬，這意味著價格波動幅度加大。反之則反。

##### 年化波動率
衡量過去一年內價格的波動程度，通常基於 252 個交易日的日收益來計算。
可以將當前的年化波動率與過去一段時間的歷史平均值比較，以評估市場波動的相對強度。若當前的年化波動率高於歷史平均，表示市場波動性加大，風險也隨之增加；反之則反。

### 流動性因子
用來衡量股票在市場上的交易難易程度，以及其交易對價格的影響程度。流動性高的股票在市場上更容易買賣，且交易對價格影響較小；反之則反。
別適合用於短期交易策略，因為流動性高的股票更易於快速買入和賣出，能降低交易成本。

#### 常見相關因子：
##### 交易量
交易量指的是在特定時間內交易的股票數量或其他資產的總數量。通常來說，高交易量代表高流動性和活躍的市場，表示該資產可以更輕鬆地買入或賣出。

##### 換手率
換手率是指在一段時間內的交易量與流通股數的比率。換手率越高，表示該股票的交易越頻繁，流動性越強，進出市場更容易。

##### 買賣價差(Bid-Ask Spread)
買賣價差是指買入價格（Bid）和賣出價格（Ask）之間的差距。流動性高的股票通常具有較小的買賣價差，買賣雙方的報價更接近；相反，流動性低的股票買賣價差較大，交易的成本相對更高。


## 快速產生多種價量因子(P2-21)
可用 TALIB 的 Python 套件。除了 TALIB，還有許多開源的 Alpha 因子資源可供使用。

### TALIB 使用介紹
先用指令(`pip install TA-Lib`)安裝，之後就可以 `import talib` 使用這個技術分析工具。此套件提供 158 種技術指標，可透過 `get_function_groups()` 函式獲取所有分類後的指標列表。這些指標根據其用途劃分為 10 個類別。

1. 週期指標(Cycle Indicators)：用來捕捉價格的週期性變化，幫助發現趨勢循環。
2. 數學運算符(Math Operators)：用於進行基礎數學運算，如加、減、乘、除，方便基本數據處理。
3. 數學變換(Math Transform)：對數據進行數學變換，可使用線性和非線性轉換，例如正弦（COS）、餘弦（SIN）、正切（TAN）、指數（EXP）等，來挖掘數據的潛在規律。
4. 動量指標(Momentum Indicators)：這些指標衡量價格變動的速度和強度，幫助識別市場的超買或超賣狀態，以及判斷價格趨勢的持續性。
5. 重疊研究(Overlap Studies)：這類指標通常疊加在價格圖上，提供直觀的視覺輔助，例如移動平均線和布林通道
6. 形態識別(Pattern Recognition)：用於識別價格圖中的各種形態或模式，如頭肩頂和頭肩底，幫助掌握市場反轉訊號。
7. 價格變換(Price Transform)：對價格數據進行變換，突出價格的特性或模式。
8. 統計函式(Statistic Functions)：透過計算平均值、標準差、相關性等指標，這些統計函式能夠顯示市場數據的特性和趨勢。
9. 波動率指標(Volatility Indicators)：用於衡量價格波動的幅度，常用於風險管理和市場波動性的預測。
10. 成交量指標(Volume Indicators)：分析市場的交易量，幫助了解市場參與者的行為和情緒。


以生成收盤價的30日移動平過線當示範
第一種方法：`talib.指標名稱(需要的欄位資料, 參數)`
import talib
talib.SMA(data['Close'], timeperiod=30)

第二種方法：`talib.abstract.指標名稱(完整的股價資料, 參數)`
from talib import abstract
talib.abstract.SMA(data, timeperiod=30)

#### 四大類價量因子對應 TALIB 中函式的範例表
1. 動量因子：
相對強弱指數(RSI)：talib.RSI
移動平均收斂發散指標(MACD)：talib.MACD
動量(Momentum)：talib.MOM
隨機震盪指數(KD)：talib.STOCH

2. 反轉因子：
布林通道(Bollinger Bands)：talib.BBANDS
隨機震盪指數(KD)：talib.STOCH

3. 流動率因子：
平均真實波幅(Average True Range)：talib.ATR
布林通道(Bollinger Bands)：talib.BBANDS
標準差(Standard Deviation)：talib.STDDEV


#### 開源的 Alphas-WorldQuant 101(P2-27)
https://github.com/yli188/WorldQuant_alpha101_code

#### 開源的 Alphas-國泰君安191(P2-30)
https://github.com/popbo/alphas


## 2.4台股操作更傾向反轉還是動能
要對動能策略進行大分類時，一般來說我們會將它分為momentum（ 順勢動能）及 reversal（反轉），我們用白話來說就是，momentum 是順勢而為，當股票呈現多頭或是正在漲勢上時，我們搭上順風車；reversal是說當股票一飛沖天時，我們寫策略去捕捉他反轉下跌的機會。

### 短期操作：把握反轉機會
在短期內，股市常會因財報公佈、公司政策變動，甚至外部突發事件而出現過度反應，導致股價大幅波動。這種波動，對於反轉策略而言是個很好的機會。反轉策略基於「過度反應會回歸正常」的假設，認為股價在短期的極端變化後往往會回到平均水平。

### 長期操作：順勢而行的動能策略
台股的長期走勢往往受到全球經濟、科技產業發展、政策變動及外資流入等因素的推動，使得整體市場呈現穩步上升的趨勢。對於長期投資者來說，動能策略較為適合，因為這種策略假設「趨勢會延續」。長期投資者可以選擇持有那些表現強勁的股票，隨著市場的長期上升趨勢持續獲利。




